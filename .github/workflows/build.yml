# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: "Push to Azure Function"

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - "data/**"
      - ".github/workflows/build.yml"
  pull_request:
    paths:
      - "src/**"
      - "tests/**"
      - "data/**"
      - ".github/workflows/build.yml"

env:
  IS_MAIN: ${{ github.ref == 'ref/heads/main' }}
  DOCKER_NAMESPACE: "cpeq"
  DOCKER_IMAGE: "infolettre-automatique"
  AZURE_CORE_OUTPUT: none # Prevents the Azure CLI from logging to stdout to prevent credentials leak

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: Install @devcontainers/cli
        run: npm install --location=global @devcontainers/cli@0.58.0

      - name: Start Dev Container
        run: |
          PYTHON_VERSION=${{ matrix.python-version }} devcontainer up --workspace-folder .

      - name: Lint package
        run: devcontainer exec --workspace-folder . poe lint

      - name: Test package
        run: devcontainer exec --workspace-folder . poe test

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          path: reports/htmlcov/
          name: coverage-report
          retention-days: 7

  dev-update-function:
    runs-on: ubuntu-latest
    needs: validate
    environment: dev
    env:
      PYTHON_VERSION: "3.11"
      POETRY_VERSION: "1.8.3"
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure Function Core Tools
        shell: bash
        run: |
          wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4

      - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "Resolve project dependencies"
        shell: bash
        run: |
          curl -sSL https://install.python-poetry.org | python -
          export PATH=$PATH:$HOME/.poetry/bin
          poetry lock --no-update
          poetry install --no-root --without dev
          # Activate venv
          poetry export -f requirements.txt --output requirements.txt
          pip install --target="./.python_packages/lib/site-packages" -r ./requirements.txt

      - name: "Deploy using Azure Function Core Tools"
        shell: bash
        run: |
          func azure functionapp publish ${{ vars.AZURE_FUNCTIONAPP_NAME }}
